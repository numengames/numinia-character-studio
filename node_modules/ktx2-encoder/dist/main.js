!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).KTX2Encoder={})}(this,function(e){"use strict";function t(){return(t=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e}).apply(this,arguments)}(u=y||(y={}))[u.cBASISTexType2D=0]="cBASISTexType2D",u[u.cBASISTexType2DArray=1]="cBASISTexType2DArray",u[u.cBASISTexTypeCubemapArray=2]="cBASISTexTypeCubemapArray",u[u.cBASISTexTypeVideoFrames=3]="cBASISTexTypeVideoFrames",u[u.cBASISTexTypeVolume=4]="cBASISTexTypeVolume",(U=d||(d={}))[U.RAW=0]="RAW",U[U.PNG=1]="PNG",U[U.JPG=2]="JPG";class n{constructor(){this.vkFormat=0,this.typeSize=1,this.pixelWidth=0,this.pixelHeight=0,this.pixelDepth=0,this.layerCount=0,this.faceCount=1,this.supercompressionScheme=0,this.levels=[],this.dataFormatDescriptor=[{vendorId:0,descriptorType:0,descriptorBlockSize:0,versionNumber:2,colorModel:0,colorPrimaries:1,transferFunction:2,flags:0,texelBlockDimension:[0,0,0,0],bytesPlane:[0,0,0,0,0,0,0,0],samples:[]}],this.keyValue={},this.globalData=null}}class i{constructor(e,t,n,i){this._dataView=void 0,this._littleEndian=void 0,this._offset=void 0,this._dataView=new DataView(e.buffer,e.byteOffset+t,n),this._littleEndian=i,this._offset=0}_nextUint8(){let e=this._dataView.getUint8(this._offset);return this._offset+=1,e}_nextUint16(){let e=this._dataView.getUint16(this._offset,this._littleEndian);return this._offset+=2,e}_nextUint32(){let e=this._dataView.getUint32(this._offset,this._littleEndian);return this._offset+=4,e}_nextUint64(){let e=this._dataView.getUint32(this._offset,this._littleEndian),t=this._dataView.getUint32(this._offset+4,this._littleEndian);return this._offset+=8,e+4294967296*t}_nextInt32(){let e=this._dataView.getInt32(this._offset,this._littleEndian);return this._offset+=4,e}_nextUint8Array(e){let t=new Uint8Array(this._dataView.buffer,this._dataView.byteOffset+this._offset,e);return this._offset+=e,t}_skip(e){return this._offset+=e,this}_scan(e,t=0){let n=this._offset,i=0;for(;this._dataView.getUint8(this._offset)!==t&&i<e;)i++,this._offset++;return i<e&&this._offset++,new Uint8Array(this._dataView.buffer,this._dataView.byteOffset+n,i)}}let r=new Uint8Array([0]),s=[171,75,84,88,32,50,48,187,13,10,26,10];function a(e){return"undefined"!=typeof TextEncoder?new TextEncoder().encode(e):Buffer.from(e)}function o(e){return"undefined"!=typeof TextDecoder?new TextDecoder().decode(e):Buffer.from(e).toString("utf8")}function l(e){let t=0;for(let n of e)t+=n.byteLength;let n=new Uint8Array(t),i=0;for(let t of e)n.set(new Uint8Array(t),i),i+=t.byteLength;return n}function f(e){let t=new Uint8Array(e.buffer,e.byteOffset,s.length);if(t[0]!==s[0]||t[1]!==s[1]||t[2]!==s[2]||t[3]!==s[3]||t[4]!==s[4]||t[5]!==s[5]||t[6]!==s[6]||t[7]!==s[7]||t[8]!==s[8]||t[9]!==s[9]||t[10]!==s[10]||t[11]!==s[11])throw Error("Missing KTX 2.0 identifier.");let r=new n,a=17*Uint32Array.BYTES_PER_ELEMENT,l=new i(e,s.length,a,!0);r.vkFormat=l._nextUint32(),r.typeSize=l._nextUint32(),r.pixelWidth=l._nextUint32(),r.pixelHeight=l._nextUint32(),r.pixelDepth=l._nextUint32(),r.layerCount=l._nextUint32(),r.faceCount=l._nextUint32();let f=l._nextUint32();r.supercompressionScheme=l._nextUint32();let c=l._nextUint32(),h=l._nextUint32(),p=l._nextUint32(),u=l._nextUint32(),U=l._nextUint64(),y=l._nextUint64(),d=new i(e,s.length+a,24*f,!0);for(let t=0;t<f;t++)r.levels.push({levelData:new Uint8Array(e.buffer,e.byteOffset+d._nextUint64(),d._nextUint64()),uncompressedByteLength:d._nextUint64()});let A=new i(e,c,h,!0),g={vendorId:A._skip(4)._nextUint16(),descriptorType:A._nextUint16(),versionNumber:A._nextUint16(),descriptorBlockSize:A._nextUint16(),colorModel:A._nextUint8(),colorPrimaries:A._nextUint8(),transferFunction:A._nextUint8(),flags:A._nextUint8(),texelBlockDimension:[A._nextUint8(),A._nextUint8(),A._nextUint8(),A._nextUint8()],bytesPlane:[A._nextUint8(),A._nextUint8(),A._nextUint8(),A._nextUint8(),A._nextUint8(),A._nextUint8(),A._nextUint8(),A._nextUint8()],samples:[]},_=(g.descriptorBlockSize/4-6)/4;for(let e=0;e<_;e++){let t={bitOffset:A._nextUint16(),bitLength:A._nextUint8(),channelType:A._nextUint8(),samplePosition:[A._nextUint8(),A._nextUint8(),A._nextUint8(),A._nextUint8()],sampleLower:-1/0,sampleUpper:1/0};64&t.channelType?(t.sampleLower=A._nextInt32(),t.sampleUpper=A._nextInt32()):(t.sampleLower=A._nextUint32(),t.sampleUpper=A._nextUint32()),g.samples[e]=t}r.dataFormatDescriptor.length=0,r.dataFormatDescriptor.push(g);let m=new i(e,p,u,!0);for(;m._offset<u;){let e=m._nextUint32(),t=m._scan(e),n=o(t);if(r.keyValue[n]=m._nextUint8Array(e-t.byteLength-1),n.match(/^ktx/i)){let e=o(r.keyValue[n]);r.keyValue[n]=e.substring(0,e.lastIndexOf("\x00"))}let i=e%4?4-e%4:0;m._skip(i)}if(y<=0)return r;let b=new i(e,U,y,!0),x=b._nextUint16(),w=b._nextUint16(),D=b._nextUint32(),S=b._nextUint32(),B=b._nextUint32(),T=b._nextUint32(),v=[];for(let e=0;e<f;e++)v.push({imageFlags:b._nextUint32(),rgbSliceByteOffset:b._nextUint32(),rgbSliceByteLength:b._nextUint32(),alphaSliceByteOffset:b._nextUint32(),alphaSliceByteLength:b._nextUint32()});let L=U+b._offset,I=L+D,k=I+S,F=new Uint8Array(e.buffer,e.byteOffset+L,D),V=new Uint8Array(e.buffer,e.byteOffset+I,S),O=new Uint8Array(e.buffer,e.byteOffset+k,B),E=new Uint8Array(e.buffer,e.byteOffset+(k+B),T);return r.globalData={endpointCount:x,selectorCount:w,imageDescs:v,endpointsData:F,selectorsData:V,tablesData:O,extendedData:E},r}function c(){return(c=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e}).apply(this,arguments)}let h={keepWriter:!1};function p(e,t={}){t=c({},h,t);let n=new ArrayBuffer(0);if(e.globalData){let t=new ArrayBuffer(20+20*e.globalData.imageDescs.length),i=new DataView(t);i.setUint16(0,e.globalData.endpointCount,!0),i.setUint16(2,e.globalData.selectorCount,!0),i.setUint32(4,e.globalData.endpointsData.byteLength,!0),i.setUint32(8,e.globalData.selectorsData.byteLength,!0),i.setUint32(12,e.globalData.tablesData.byteLength,!0),i.setUint32(16,e.globalData.extendedData.byteLength,!0);for(let t=0;t<e.globalData.imageDescs.length;t++){let n=e.globalData.imageDescs[t];i.setUint32(20+20*t+0,n.imageFlags,!0),i.setUint32(20+20*t+4,n.rgbSliceByteOffset,!0),i.setUint32(20+20*t+8,n.rgbSliceByteLength,!0),i.setUint32(20+20*t+12,n.alphaSliceByteOffset,!0),i.setUint32(20+20*t+16,n.alphaSliceByteLength,!0)}n=l([t,e.globalData.endpointsData,e.globalData.selectorsData,e.globalData.tablesData,e.globalData.extendedData])}let i=[],o=e.keyValue;for(let n in t.keepWriter||(o=c({},e.keyValue,{KTXwriter:"KTX-Parse v0.6.0"})),o){let e=o[n],t=a(n),s="string"==typeof e?l([a(e),r]):e,f=t.byteLength+1+s.byteLength,c=f%4?4-f%4:0;i.push(l([new Uint32Array([f]),t,r,s,new Uint8Array(c).fill(0)]))}let f=l(i);if(1!==e.dataFormatDescriptor.length||0!==e.dataFormatDescriptor[0].descriptorType)throw Error("Only BASICFORMAT Data Format Descriptor output supported.");let p=e.dataFormatDescriptor[0],u=new ArrayBuffer(28+16*p.samples.length),U=new DataView(u),y=24+16*p.samples.length;if(U.setUint32(0,u.byteLength,!0),U.setUint16(4,p.vendorId,!0),U.setUint16(6,p.descriptorType,!0),U.setUint16(8,p.versionNumber,!0),U.setUint16(10,y,!0),U.setUint8(12,p.colorModel),U.setUint8(13,p.colorPrimaries),U.setUint8(14,p.transferFunction),U.setUint8(15,p.flags),!Array.isArray(p.texelBlockDimension))throw Error("texelBlockDimension is now an array. For dimensionality `d`, set `d - 1`.");U.setUint8(16,p.texelBlockDimension[0]),U.setUint8(17,p.texelBlockDimension[1]),U.setUint8(18,p.texelBlockDimension[2]),U.setUint8(19,p.texelBlockDimension[3]);for(let e=0;e<8;e++)U.setUint8(20+e,p.bytesPlane[e]);for(let e=0;e<p.samples.length;e++){let t=p.samples[e],n=28+16*e;if(t.channelID)throw Error("channelID has been renamed to channelType.");U.setUint16(n+0,t.bitOffset,!0),U.setUint8(n+2,t.bitLength),U.setUint8(n+3,t.channelType),U.setUint8(n+4,t.samplePosition[0]),U.setUint8(n+5,t.samplePosition[1]),U.setUint8(n+6,t.samplePosition[2]),U.setUint8(n+7,t.samplePosition[3]),64&t.channelType?(U.setInt32(n+8,t.sampleLower,!0),U.setInt32(n+12,t.sampleUpper,!0)):(U.setUint32(n+8,t.sampleLower,!0),U.setUint32(n+12,t.sampleUpper,!0))}let d=s.length+68+24*e.levels.length,A=d+u.byteLength,g=n.byteLength>0?A+f.byteLength:0;g%8&&(g+=8-g%8);let _=[],m=new DataView(new ArrayBuffer(24*e.levels.length)),b=(g||A+f.byteLength)+n.byteLength;for(let t=0;t<e.levels.length;t++){let n=e.levels[t];_.push(n.levelData),m.setBigUint64(24*t+0,BigInt(b),!0),m.setBigUint64(24*t+8,BigInt(n.levelData.byteLength),!0),m.setBigUint64(24*t+16,BigInt(n.uncompressedByteLength),!0),b+=n.levelData.byteLength}let x=new ArrayBuffer(68),w=new DataView(x);return w.setUint32(0,e.vkFormat,!0),w.setUint32(4,e.typeSize,!0),w.setUint32(8,e.pixelWidth,!0),w.setUint32(12,e.pixelHeight,!0),w.setUint32(16,e.pixelDepth,!0),w.setUint32(20,e.layerCount,!0),w.setUint32(24,e.faceCount,!0),w.setUint32(28,e.levels.length,!0),w.setUint32(32,e.supercompressionScheme,!0),w.setUint32(36,d,!0),w.setUint32(40,u.byteLength,!0),w.setUint32(44,A,!0),w.setUint32(48,f.byteLength,!0),w.setBigUint64(52,BigInt(n.byteLength>0?g:0),!0),w.setBigUint64(60,BigInt(n.byteLength),!0),new Uint8Array(l([new Uint8Array(s).buffer,x,m.buffer,u,f,new ArrayBuffer(g>0?g-(A+f.byteLength):0),n,..._]))}var u,U,y,d,A={enableDebug:!1,isUASTC:!0,isKTX2File:!0,isInputSRGB:!0,generateMipmap:!0,needSupercompression:!0,isSetKTX2SRGBTransferFunc:!0},g=new OffscreenCanvas(128,128),_=g.getContext("2d",{willReadFrequently:!0}),m="undefined"==typeof document;function b(e,n){void 0===e&&(e={}),void 0!==(e=function(){return t.apply(this,arguments)}({},A,e)).enableDebug&&n.setDebug(e.enableDebug),void 0!==e.isUASTC&&n.setUASTC(e.isUASTC),void 0!==e.isKTX2File&&n.setCreateKTX2File(e.isKTX2File),void 0!==e.isSetKTX2SRGBTransferFunc&&n.setKTX2SRGBTransferFunc(e.isSetKTX2SRGBTransferFunc),void 0!==e.generateMipmap&&n.setMipGen(e.generateMipmap),void 0!==e.isYFlip&&n.setYFlip(e.isYFlip),void 0!==e.qualityLevel&&n.setQualityLevel(e.qualityLevel),void 0!==e.compressionLevel&&n.setCompressionLevel(e.compressionLevel),void 0!==e.needSupercompression&&n.setKTX2UASTCSupercompression(e.needSupercompression),void 0!==e.isNormalMap&&n.setNormalMap(e.isNormalMap)}var x=null;function w(){return x||(x=new Promise(function(e,t){m?(importScripts("https://mdn.alipayobjects.com/rms/afts/file/A*SrRkQarYYl4AAAAAAAAAAAAAARQnAQ/basis_encoder.js"),fetch("https://mdn.alipayobjects.com/rms/afts/file/A*qFWbTrA0hZYAAAAAAAAAAAAAARQnAQ/basis_encoder.wasm").then(function(e){return e.arrayBuffer()}).then(function(n){BASIS({wasmBinary:n}).then(function(t){t.initializeBasis(),e(t)}).catch(t)}).catch(t)):Promise.all([fetch("https://mdn.alipayobjects.com/rms/afts/file/A*SrRkQarYYl4AAAAAAAAAAAAAARQnAQ/basis_encoder.js").then(function(e){return e.text()}),fetch("https://mdn.alipayobjects.com/rms/afts/file/A*qFWbTrA0hZYAAAAAAAAAAAAAARQnAQ/basis_encoder.wasm").then(function(e){return e.arrayBuffer()})]).then(function(n){var i=n[0],r=n[1],s=document.createElement("script");s.onload=function(){BASIS({wasmBinary:r}).then(function(t){t.initializeBasis(),e(t)}).catch(t)},s.src=URL.createObjectURL(new Blob([i])),s.onerror=t,document.body.appendChild(s)}).catch(t)})),x}m&&self.addEventListener("message",function(e){var t,n;(t=e.data,void 0===n&&(n={}),w().then(function(e){var i,r=new e.BasisEncoder;b(n,r),r.setTexType(y.cBASISTexType2D),r.setSliceSourceImage(0,new Uint8Array(t),0,0,null!=(i=n.type)?i:d.PNG);var s=new Uint8Array(10485760),a=r.encode(s);if(0===a)throw"encode failed";var o=new Uint8Array(s.buffer,0,a),l=f(s);if(n.kvData){for(var c in n.kvData)l.keyValue[c]=n.kvData[c];o=p(l,{keepWriter:!0})}return r.delete(),o})).then(function(e){self.postMessage(e)}).catch(function(e){throw e})}),e.encodeToKTX2=function(e,t){return void 0===t&&(t={}),w().then(function(n){var i,r,s,a=new n.BasisEncoder;return b(t,a),a.setTexType(y.cBASISTexType2D),i=e,(null!=(r=ArrayBuffer)&&"undefined"!=typeof Symbol&&r[Symbol.hasInstance]?!!r[Symbol.hasInstance](i):i instanceof r)&&(e=new Blob([e])),(s=e,createImageBitmap(s).then(function(e){return g.width=e.width,g.height=e.height,_.drawImage(e,0,0),_.getImageData(0,0,e.width,e.height)})).then(function(e){a.setSliceSourceImage(0,new Uint8Array(e.data),e.width,e.height,d.RAW);var n=new Uint8Array(10485760),i=a.encode(n);if(0===i)throw"encode failed";var r=new Uint8Array(n.buffer,0,i),s=f(n);if(t.kvData){for(var o in t.kvData)s.keyValue[o]=t.kvData[o];r=p(s,{keepWriter:!0})}return r})})}});
