!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).KTX2Encoder={})}(this,function(e){"use strict";function t(){return(t=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e}).apply(this,arguments)}(h=U||(U={}))[h.cBASISTexType2D=0]="cBASISTexType2D",h[h.cBASISTexType2DArray=1]="cBASISTexType2DArray",h[h.cBASISTexTypeCubemapArray=2]="cBASISTexTypeCubemapArray",h[h.cBASISTexTypeVideoFrames=3]="cBASISTexTypeVideoFrames",h[h.cBASISTexTypeVolume=4]="cBASISTexTypeVolume",(p=u||(u={}))[p.RAW=0]="RAW",p[p.PNG=1]="PNG",p[p.JPG=2]="JPG";class n{constructor(){this.vkFormat=0,this.typeSize=1,this.pixelWidth=0,this.pixelHeight=0,this.pixelDepth=0,this.layerCount=0,this.faceCount=1,this.supercompressionScheme=0,this.levels=[],this.dataFormatDescriptor=[{vendorId:0,descriptorType:0,descriptorBlockSize:0,versionNumber:2,colorModel:0,colorPrimaries:1,transferFunction:2,flags:0,texelBlockDimension:[0,0,0,0],bytesPlane:[0,0,0,0,0,0,0,0],samples:[]}],this.keyValue={},this.globalData=null}}class i{constructor(e,t,n,i){this._dataView=void 0,this._littleEndian=void 0,this._offset=void 0,this._dataView=new DataView(e.buffer,e.byteOffset+t,n),this._littleEndian=i,this._offset=0}_nextUint8(){let e=this._dataView.getUint8(this._offset);return this._offset+=1,e}_nextUint16(){let e=this._dataView.getUint16(this._offset,this._littleEndian);return this._offset+=2,e}_nextUint32(){let e=this._dataView.getUint32(this._offset,this._littleEndian);return this._offset+=4,e}_nextUint64(){let e=this._dataView.getUint32(this._offset,this._littleEndian),t=this._dataView.getUint32(this._offset+4,this._littleEndian);return this._offset+=8,e+4294967296*t}_nextInt32(){let e=this._dataView.getInt32(this._offset,this._littleEndian);return this._offset+=4,e}_nextUint8Array(e){let t=new Uint8Array(this._dataView.buffer,this._dataView.byteOffset+this._offset,e);return this._offset+=e,t}_skip(e){return this._offset+=e,this}_scan(e,t=0){let n=this._offset,i=0;for(;this._dataView.getUint8(this._offset)!==t&&i<e;)i++,this._offset++;return i<e&&this._offset++,new Uint8Array(this._dataView.buffer,this._dataView.byteOffset+n,i)}}let s=new Uint8Array([0]),r=[171,75,84,88,32,50,48,187,13,10,26,10];function a(e){return"undefined"!=typeof TextEncoder?new TextEncoder().encode(e):Buffer.from(e)}function o(e){return"undefined"!=typeof TextDecoder?new TextDecoder().decode(e):Buffer.from(e).toString("utf8")}function l(e){let t=0;for(let n of e)t+=n.byteLength;let n=new Uint8Array(t),i=0;for(let t of e)n.set(new Uint8Array(t),i),i+=t.byteLength;return n}function f(){return(f=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e}).apply(this,arguments)}let c={keepWriter:!1};var h,p,U,u,y={enableDebug:!1,isUASTC:!0,isKTX2File:!0,isInputSRGB:!0,generateMipmap:!0,needSupercompression:!0,isSetKTX2SRGBTransferFunc:!0},d=new OffscreenCanvas(128,128),g=d.getContext("2d",{willReadFrequently:!0}),A="undefined"==typeof document;function _(e,h){return void 0===h&&(h={}),(m||(m=new Promise(function(e,t){A?(importScripts("https://mdn.alipayobjects.com/rms/afts/file/A*SrRkQarYYl4AAAAAAAAAAAAAARQnAQ/basis_encoder.js"),fetch("https://mdn.alipayobjects.com/rms/afts/file/A*qFWbTrA0hZYAAAAAAAAAAAAAARQnAQ/basis_encoder.wasm").then(function(e){return e.arrayBuffer()}).then(function(n){BASIS({wasmBinary:n}).then(function(t){t.initializeBasis(),e(t)}).catch(t)}).catch(t)):Promise.all([fetch("https://mdn.alipayobjects.com/rms/afts/file/A*SrRkQarYYl4AAAAAAAAAAAAAARQnAQ/basis_encoder.js").then(function(e){return e.text()}),fetch("https://mdn.alipayobjects.com/rms/afts/file/A*qFWbTrA0hZYAAAAAAAAAAAAAARQnAQ/basis_encoder.wasm").then(function(e){return e.arrayBuffer()})]).then(function(n){var i=n[0],s=n[1],r=document.createElement("script");r.onload=function(){BASIS({wasmBinary:s}).then(function(t){t.initializeBasis(),e(t)}).catch(t)},r.src=URL.createObjectURL(new Blob([i])),r.onerror=t,document.body.appendChild(r)}).catch(t)})),m).then(function(p){var A,_,m,b,x=new p.BasisEncoder;return void 0===(A=h)&&(A={}),void 0!==(A=function(){return t.apply(this,arguments)}({},y,A)).enableDebug&&x.setDebug(A.enableDebug),void 0!==A.isUASTC&&x.setUASTC(A.isUASTC),void 0!==A.isKTX2File&&x.setCreateKTX2File(A.isKTX2File),void 0!==A.isSetKTX2SRGBTransferFunc&&x.setKTX2SRGBTransferFunc(A.isSetKTX2SRGBTransferFunc),void 0!==A.generateMipmap&&x.setMipGen(A.generateMipmap),void 0!==A.isYFlip&&x.setYFlip(A.isYFlip),void 0!==A.qualityLevel&&x.setQualityLevel(A.qualityLevel),void 0!==A.compressionLevel&&x.setCompressionLevel(A.compressionLevel),void 0!==A.needSupercompression&&x.setKTX2UASTCSupercompression(A.needSupercompression),void 0!==A.isNormalMap&&x.setNormalMap(A.isNormalMap),x.setTexType(U.cBASISTexType2D),_=e,(null!=(m=ArrayBuffer)&&"undefined"!=typeof Symbol&&m[Symbol.hasInstance]?!!m[Symbol.hasInstance](_):_ instanceof m)&&(e=new Blob([e])),(b=e,createImageBitmap(b).then(function(e){return d.width=e.width,d.height=e.height,g.drawImage(e,0,0),g.getImageData(0,0,e.width,e.height)})).then(function(e){x.setSliceSourceImage(0,new Uint8Array(e.data),e.width,e.height,u.RAW);var t=new Uint8Array(10485760),p=x.encode(t);if(0===p)throw"encode failed";var U=new Uint8Array(t.buffer,0,p),y=function(e){let t=new Uint8Array(e.buffer,e.byteOffset,r.length);if(t[0]!==r[0]||t[1]!==r[1]||t[2]!==r[2]||t[3]!==r[3]||t[4]!==r[4]||t[5]!==r[5]||t[6]!==r[6]||t[7]!==r[7]||t[8]!==r[8]||t[9]!==r[9]||t[10]!==r[10]||t[11]!==r[11])throw Error("Missing KTX 2.0 identifier.");let s=new n,a=17*Uint32Array.BYTES_PER_ELEMENT,l=new i(e,r.length,a,!0);s.vkFormat=l._nextUint32(),s.typeSize=l._nextUint32(),s.pixelWidth=l._nextUint32(),s.pixelHeight=l._nextUint32(),s.pixelDepth=l._nextUint32(),s.layerCount=l._nextUint32(),s.faceCount=l._nextUint32();let f=l._nextUint32();s.supercompressionScheme=l._nextUint32();let c=l._nextUint32(),h=l._nextUint32(),p=l._nextUint32(),U=l._nextUint32(),u=l._nextUint64(),y=l._nextUint64(),d=new i(e,r.length+a,24*f,!0);for(let t=0;t<f;t++)s.levels.push({levelData:new Uint8Array(e.buffer,e.byteOffset+d._nextUint64(),d._nextUint64()),uncompressedByteLength:d._nextUint64()});let g=new i(e,c,h,!0),A={vendorId:g._skip(4)._nextUint16(),descriptorType:g._nextUint16(),versionNumber:g._nextUint16(),descriptorBlockSize:g._nextUint16(),colorModel:g._nextUint8(),colorPrimaries:g._nextUint8(),transferFunction:g._nextUint8(),flags:g._nextUint8(),texelBlockDimension:[g._nextUint8(),g._nextUint8(),g._nextUint8(),g._nextUint8()],bytesPlane:[g._nextUint8(),g._nextUint8(),g._nextUint8(),g._nextUint8(),g._nextUint8(),g._nextUint8(),g._nextUint8(),g._nextUint8()],samples:[]},_=(A.descriptorBlockSize/4-6)/4;for(let e=0;e<_;e++){let t={bitOffset:g._nextUint16(),bitLength:g._nextUint8(),channelType:g._nextUint8(),samplePosition:[g._nextUint8(),g._nextUint8(),g._nextUint8(),g._nextUint8()],sampleLower:-1/0,sampleUpper:1/0};64&t.channelType?(t.sampleLower=g._nextInt32(),t.sampleUpper=g._nextInt32()):(t.sampleLower=g._nextUint32(),t.sampleUpper=g._nextUint32()),A.samples[e]=t}s.dataFormatDescriptor.length=0,s.dataFormatDescriptor.push(A);let m=new i(e,p,U,!0);for(;m._offset<U;){let e=m._nextUint32(),t=m._scan(e),n=o(t);if(s.keyValue[n]=m._nextUint8Array(e-t.byteLength-1),n.match(/^ktx/i)){let e=o(s.keyValue[n]);s.keyValue[n]=e.substring(0,e.lastIndexOf("\x00"))}let i=e%4?4-e%4:0;m._skip(i)}if(y<=0)return s;let b=new i(e,u,y,!0),x=b._nextUint16(),w=b._nextUint16(),D=b._nextUint32(),S=b._nextUint32(),B=b._nextUint32(),T=b._nextUint32(),v=[];for(let e=0;e<f;e++)v.push({imageFlags:b._nextUint32(),rgbSliceByteOffset:b._nextUint32(),rgbSliceByteLength:b._nextUint32(),alphaSliceByteOffset:b._nextUint32(),alphaSliceByteLength:b._nextUint32()});let L=u+b._offset,I=L+D,k=I+S,F=new Uint8Array(e.buffer,e.byteOffset+L,D),V=new Uint8Array(e.buffer,e.byteOffset+I,S),O=new Uint8Array(e.buffer,e.byteOffset+k,B),E=new Uint8Array(e.buffer,e.byteOffset+(k+B),T);return s.globalData={endpointCount:x,selectorCount:w,imageDescs:v,endpointsData:F,selectorsData:V,tablesData:O,extendedData:E},s}(t);if(h.kvData){for(var d in h.kvData)y.keyValue[d]=h.kvData[d];U=function(e,t={}){t=f({},c,t);let n=new ArrayBuffer(0);if(e.globalData){let t=new ArrayBuffer(20+20*e.globalData.imageDescs.length),i=new DataView(t);i.setUint16(0,e.globalData.endpointCount,!0),i.setUint16(2,e.globalData.selectorCount,!0),i.setUint32(4,e.globalData.endpointsData.byteLength,!0),i.setUint32(8,e.globalData.selectorsData.byteLength,!0),i.setUint32(12,e.globalData.tablesData.byteLength,!0),i.setUint32(16,e.globalData.extendedData.byteLength,!0);for(let t=0;t<e.globalData.imageDescs.length;t++){let n=e.globalData.imageDescs[t];i.setUint32(20+20*t+0,n.imageFlags,!0),i.setUint32(20+20*t+4,n.rgbSliceByteOffset,!0),i.setUint32(20+20*t+8,n.rgbSliceByteLength,!0),i.setUint32(20+20*t+12,n.alphaSliceByteOffset,!0),i.setUint32(20+20*t+16,n.alphaSliceByteLength,!0)}n=l([t,e.globalData.endpointsData,e.globalData.selectorsData,e.globalData.tablesData,e.globalData.extendedData])}let i=[],o=e.keyValue;for(let n in t.keepWriter||(o=f({},e.keyValue,{KTXwriter:"KTX-Parse v0.6.0"})),o){let e=o[n],t=a(n),r="string"==typeof e?l([a(e),s]):e,f=t.byteLength+1+r.byteLength,c=f%4?4-f%4:0;i.push(l([new Uint32Array([f]),t,s,r,new Uint8Array(c).fill(0)]))}let h=l(i);if(1!==e.dataFormatDescriptor.length||0!==e.dataFormatDescriptor[0].descriptorType)throw Error("Only BASICFORMAT Data Format Descriptor output supported.");let p=e.dataFormatDescriptor[0],U=new ArrayBuffer(28+16*p.samples.length),u=new DataView(U),y=24+16*p.samples.length;if(u.setUint32(0,U.byteLength,!0),u.setUint16(4,p.vendorId,!0),u.setUint16(6,p.descriptorType,!0),u.setUint16(8,p.versionNumber,!0),u.setUint16(10,y,!0),u.setUint8(12,p.colorModel),u.setUint8(13,p.colorPrimaries),u.setUint8(14,p.transferFunction),u.setUint8(15,p.flags),!Array.isArray(p.texelBlockDimension))throw Error("texelBlockDimension is now an array. For dimensionality `d`, set `d - 1`.");u.setUint8(16,p.texelBlockDimension[0]),u.setUint8(17,p.texelBlockDimension[1]),u.setUint8(18,p.texelBlockDimension[2]),u.setUint8(19,p.texelBlockDimension[3]);for(let e=0;e<8;e++)u.setUint8(20+e,p.bytesPlane[e]);for(let e=0;e<p.samples.length;e++){let t=p.samples[e],n=28+16*e;if(t.channelID)throw Error("channelID has been renamed to channelType.");u.setUint16(n+0,t.bitOffset,!0),u.setUint8(n+2,t.bitLength),u.setUint8(n+3,t.channelType),u.setUint8(n+4,t.samplePosition[0]),u.setUint8(n+5,t.samplePosition[1]),u.setUint8(n+6,t.samplePosition[2]),u.setUint8(n+7,t.samplePosition[3]),64&t.channelType?(u.setInt32(n+8,t.sampleLower,!0),u.setInt32(n+12,t.sampleUpper,!0)):(u.setUint32(n+8,t.sampleLower,!0),u.setUint32(n+12,t.sampleUpper,!0))}let d=r.length+68+24*e.levels.length,g=d+U.byteLength,A=n.byteLength>0?g+h.byteLength:0;A%8&&(A+=8-A%8);let _=[],m=new DataView(new ArrayBuffer(24*e.levels.length)),b=(A||g+h.byteLength)+n.byteLength;for(let t=0;t<e.levels.length;t++){let n=e.levels[t];_.push(n.levelData),m.setBigUint64(24*t+0,BigInt(b),!0),m.setBigUint64(24*t+8,BigInt(n.levelData.byteLength),!0),m.setBigUint64(24*t+16,BigInt(n.uncompressedByteLength),!0),b+=n.levelData.byteLength}let x=new ArrayBuffer(68),w=new DataView(x);return w.setUint32(0,e.vkFormat,!0),w.setUint32(4,e.typeSize,!0),w.setUint32(8,e.pixelWidth,!0),w.setUint32(12,e.pixelHeight,!0),w.setUint32(16,e.pixelDepth,!0),w.setUint32(20,e.layerCount,!0),w.setUint32(24,e.faceCount,!0),w.setUint32(28,e.levels.length,!0),w.setUint32(32,e.supercompressionScheme,!0),w.setUint32(36,d,!0),w.setUint32(40,U.byteLength,!0),w.setUint32(44,g,!0),w.setUint32(48,h.byteLength,!0),w.setBigUint64(52,BigInt(n.byteLength>0?A:0),!0),w.setBigUint64(60,BigInt(n.byteLength),!0),new Uint8Array(l([new Uint8Array(r).buffer,x,m.buffer,U,h,new ArrayBuffer(A>0?A-(g+h.byteLength):0),n,..._]))}(y,{keepWriter:!0})}return U})})}var m=null;A&&self.addEventListener("message",function(e){_(e.data).then(function(e){self.postMessage(e)}).catch(function(e){self.postMessage({error:e})})}),e.encodeToKTX2=_});
