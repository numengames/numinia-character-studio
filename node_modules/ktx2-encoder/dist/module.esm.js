function extends_(){return(extends_=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e}).apply(this,arguments)}function _extends$1(){return extends_.apply(this,arguments)}function _instanceof(e,t){return null!=t&&"undefined"!=typeof Symbol&&t[Symbol.hasInstance]?!!t[Symbol.hasInstance](e):e instanceof t}!function(e){e[e.cBASISTexType2D=0]="cBASISTexType2D",e[e.cBASISTexType2DArray=1]="cBASISTexType2DArray",e[e.cBASISTexTypeCubemapArray=2]="cBASISTexTypeCubemapArray",e[e.cBASISTexTypeVideoFrames=3]="cBASISTexTypeVideoFrames",e[e.cBASISTexTypeVolume=4]="cBASISTexTypeVolume"}(BasisTextureType||(BasisTextureType={})),function(e){e[e.RAW=0]="RAW",e[e.PNG=1]="PNG",e[e.JPG=2]="JPG"}(SourceType||(SourceType={}));let KHR_SUPERCOMPRESSION_NONE=0,KHR_DF_KHR_DESCRIPTORTYPE_BASICFORMAT=0,KHR_DF_VENDORID_KHRONOS=0,KHR_DF_VERSION=2,KHR_DF_MODEL_UNSPECIFIED=0,KHR_DF_FLAG_ALPHA_STRAIGHT=0,KHR_DF_TRANSFER_SRGB=2,KHR_DF_PRIMARIES_BT709=1,KHR_DF_SAMPLE_DATATYPE_SIGNED=64,VK_FORMAT_UNDEFINED=0;class KTX2Container{constructor(){this.vkFormat=0,this.typeSize=1,this.pixelWidth=0,this.pixelHeight=0,this.pixelDepth=0,this.layerCount=0,this.faceCount=1,this.supercompressionScheme=0,this.levels=[],this.dataFormatDescriptor=[{vendorId:0,descriptorType:0,descriptorBlockSize:0,versionNumber:2,colorModel:0,colorPrimaries:1,transferFunction:2,flags:0,texelBlockDimension:[0,0,0,0],bytesPlane:[0,0,0,0,0,0,0,0],samples:[]}],this.keyValue={},this.globalData=null}}class BufferReader{constructor(e,t,n,i){this._dataView=void 0,this._littleEndian=void 0,this._offset=void 0,this._dataView=new DataView(e.buffer,e.byteOffset+t,n),this._littleEndian=i,this._offset=0}_nextUint8(){let e=this._dataView.getUint8(this._offset);return this._offset+=1,e}_nextUint16(){let e=this._dataView.getUint16(this._offset,this._littleEndian);return this._offset+=2,e}_nextUint32(){let e=this._dataView.getUint32(this._offset,this._littleEndian);return this._offset+=4,e}_nextUint64(){let e=this._dataView.getUint32(this._offset,this._littleEndian),t=this._dataView.getUint32(this._offset+4,this._littleEndian);return this._offset+=8,e+4294967296*t}_nextInt32(){let e=this._dataView.getInt32(this._offset,this._littleEndian);return this._offset+=4,e}_nextUint8Array(e){let t=new Uint8Array(this._dataView.buffer,this._dataView.byteOffset+this._offset,e);return this._offset+=e,t}_skip(e){return this._offset+=e,this}_scan(e,t=0){let n=this._offset,i=0;for(;this._dataView.getUint8(this._offset)!==t&&i<e;)i++,this._offset++;return i<e&&this._offset++,new Uint8Array(this._dataView.buffer,this._dataView.byteOffset+n,i)}}let KTX_WRITER="KTX-Parse v0.6.0",NUL=new Uint8Array([0]),KTX2_ID=[171,75,84,88,32,50,48,187,13,10,26,10],HEADER_BYTE_LENGTH=68;function encodeText(e){return"undefined"!=typeof TextEncoder?new TextEncoder().encode(e):Buffer.from(e)}function decodeText(e){return"undefined"!=typeof TextDecoder?new TextDecoder().decode(e):Buffer.from(e).toString("utf8")}function concat(e){let t=0;for(let n of e)t+=n.byteLength;let n=new Uint8Array(t),i=0;for(let t of e)n.set(new Uint8Array(t),i),i+=t.byteLength;return n}function read(e){let t=new Uint8Array(e.buffer,e.byteOffset,KTX2_ID.length);if(t[0]!==KTX2_ID[0]||t[1]!==KTX2_ID[1]||t[2]!==KTX2_ID[2]||t[3]!==KTX2_ID[3]||t[4]!==KTX2_ID[4]||t[5]!==KTX2_ID[5]||t[6]!==KTX2_ID[6]||t[7]!==KTX2_ID[7]||t[8]!==KTX2_ID[8]||t[9]!==KTX2_ID[9]||t[10]!==KTX2_ID[10]||t[11]!==KTX2_ID[11])throw Error("Missing KTX 2.0 identifier.");let n=new KTX2Container,i=17*Uint32Array.BYTES_PER_ELEMENT,s=new BufferReader(e,KTX2_ID.length,i,!0);n.vkFormat=s._nextUint32(),n.typeSize=s._nextUint32(),n.pixelWidth=s._nextUint32(),n.pixelHeight=s._nextUint32(),n.pixelDepth=s._nextUint32(),n.layerCount=s._nextUint32(),n.faceCount=s._nextUint32();let r=s._nextUint32();n.supercompressionScheme=s._nextUint32();let a=s._nextUint32(),o=s._nextUint32(),l=s._nextUint32(),f=s._nextUint32(),c=s._nextUint64(),p=s._nextUint64(),_=new BufferReader(e,KTX2_ID.length+i,24*r,!0);for(let t=0;t<r;t++)n.levels.push({levelData:new Uint8Array(e.buffer,e.byteOffset+_._nextUint64(),_._nextUint64()),uncompressedByteLength:_._nextUint64()});let h=new BufferReader(e,a,o,!0),u={vendorId:h._skip(4)._nextUint16(),descriptorType:h._nextUint16(),versionNumber:h._nextUint16(),descriptorBlockSize:h._nextUint16(),colorModel:h._nextUint8(),colorPrimaries:h._nextUint8(),transferFunction:h._nextUint8(),flags:h._nextUint8(),texelBlockDimension:[h._nextUint8(),h._nextUint8(),h._nextUint8(),h._nextUint8()],bytesPlane:[h._nextUint8(),h._nextUint8(),h._nextUint8(),h._nextUint8(),h._nextUint8(),h._nextUint8(),h._nextUint8(),h._nextUint8()],samples:[]},U=(u.descriptorBlockSize/4-6)/4;for(let e=0;e<U;e++){let t={bitOffset:h._nextUint16(),bitLength:h._nextUint8(),channelType:h._nextUint8(),samplePosition:[h._nextUint8(),h._nextUint8(),h._nextUint8(),h._nextUint8()],sampleLower:-1/0,sampleUpper:1/0};64&t.channelType?(t.sampleLower=h._nextInt32(),t.sampleUpper=h._nextInt32()):(t.sampleLower=h._nextUint32(),t.sampleUpper=h._nextUint32()),u.samples[e]=t}n.dataFormatDescriptor.length=0,n.dataFormatDescriptor.push(u);let d=new BufferReader(e,l,f,!0);for(;d._offset<f;){let e=d._nextUint32(),t=d._scan(e),i=decodeText(t);if(n.keyValue[i]=d._nextUint8Array(e-t.byteLength-1),i.match(/^ktx/i)){let e=decodeText(n.keyValue[i]);n.keyValue[i]=e.substring(0,e.lastIndexOf("\x00"))}let s=e%4?4-e%4:0;d._skip(s)}if(p<=0)return n;let y=new BufferReader(e,c,p,!0),A=y._nextUint16(),x=y._nextUint16(),g=y._nextUint32(),T=y._nextUint32(),m=y._nextUint32(),D=y._nextUint32(),b=[];for(let e=0;e<r;e++)b.push({imageFlags:y._nextUint32(),rgbSliceByteOffset:y._nextUint32(),rgbSliceByteLength:y._nextUint32(),alphaSliceByteOffset:y._nextUint32(),alphaSliceByteLength:y._nextUint32()});let S=c+y._offset,w=S+g,B=w+T,I=new Uint8Array(e.buffer,e.byteOffset+S,g),v=new Uint8Array(e.buffer,e.byteOffset+w,T),L=new Uint8Array(e.buffer,e.byteOffset+B,m),R=new Uint8Array(e.buffer,e.byteOffset+(B+m),D);return n.globalData={endpointCount:A,selectorCount:x,imageDescs:b,endpointsData:I,selectorsData:v,tablesData:L,extendedData:R},n}function _extends(){return(_extends=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e}).apply(this,arguments)}let DEFAULT_OPTIONS={keepWriter:!1};function write(e,t={}){t=_extends({},DEFAULT_OPTIONS,t);let n=new ArrayBuffer(0);if(e.globalData){let t=new ArrayBuffer(20+20*e.globalData.imageDescs.length),i=new DataView(t);i.setUint16(0,e.globalData.endpointCount,!0),i.setUint16(2,e.globalData.selectorCount,!0),i.setUint32(4,e.globalData.endpointsData.byteLength,!0),i.setUint32(8,e.globalData.selectorsData.byteLength,!0),i.setUint32(12,e.globalData.tablesData.byteLength,!0),i.setUint32(16,e.globalData.extendedData.byteLength,!0);for(let t=0;t<e.globalData.imageDescs.length;t++){let n=e.globalData.imageDescs[t];i.setUint32(20+20*t+0,n.imageFlags,!0),i.setUint32(20+20*t+4,n.rgbSliceByteOffset,!0),i.setUint32(20+20*t+8,n.rgbSliceByteLength,!0),i.setUint32(20+20*t+12,n.alphaSliceByteOffset,!0),i.setUint32(20+20*t+16,n.alphaSliceByteLength,!0)}n=concat([t,e.globalData.endpointsData,e.globalData.selectorsData,e.globalData.tablesData,e.globalData.extendedData])}let i=[],s=e.keyValue;for(let n in t.keepWriter||(s=_extends({},e.keyValue,{KTXwriter:"KTX-Parse v0.6.0"})),s){let e=s[n],t=encodeText(n),r="string"==typeof e?concat([encodeText(e),NUL]):e,a=t.byteLength+1+r.byteLength,o=a%4?4-a%4:0;i.push(concat([new Uint32Array([a]),t,NUL,r,new Uint8Array(o).fill(0)]))}let r=concat(i);if(1!==e.dataFormatDescriptor.length||0!==e.dataFormatDescriptor[0].descriptorType)throw Error("Only BASICFORMAT Data Format Descriptor output supported.");let a=e.dataFormatDescriptor[0],o=new ArrayBuffer(28+16*a.samples.length),l=new DataView(o),f=24+16*a.samples.length;if(l.setUint32(0,o.byteLength,!0),l.setUint16(4,a.vendorId,!0),l.setUint16(6,a.descriptorType,!0),l.setUint16(8,a.versionNumber,!0),l.setUint16(10,f,!0),l.setUint8(12,a.colorModel),l.setUint8(13,a.colorPrimaries),l.setUint8(14,a.transferFunction),l.setUint8(15,a.flags),!Array.isArray(a.texelBlockDimension))throw Error("texelBlockDimension is now an array. For dimensionality `d`, set `d - 1`.");l.setUint8(16,a.texelBlockDimension[0]),l.setUint8(17,a.texelBlockDimension[1]),l.setUint8(18,a.texelBlockDimension[2]),l.setUint8(19,a.texelBlockDimension[3]);for(let e=0;e<8;e++)l.setUint8(20+e,a.bytesPlane[e]);for(let e=0;e<a.samples.length;e++){let t=a.samples[e],n=28+16*e;if(t.channelID)throw Error("channelID has been renamed to channelType.");l.setUint16(n+0,t.bitOffset,!0),l.setUint8(n+2,t.bitLength),l.setUint8(n+3,t.channelType),l.setUint8(n+4,t.samplePosition[0]),l.setUint8(n+5,t.samplePosition[1]),l.setUint8(n+6,t.samplePosition[2]),l.setUint8(n+7,t.samplePosition[3]),64&t.channelType?(l.setInt32(n+8,t.sampleLower,!0),l.setInt32(n+12,t.sampleUpper,!0)):(l.setUint32(n+8,t.sampleLower,!0),l.setUint32(n+12,t.sampleUpper,!0))}let c=KTX2_ID.length+68+24*e.levels.length,p=c+o.byteLength,_=n.byteLength>0?p+r.byteLength:0;_%8&&(_+=8-_%8);let h=[],u=new DataView(new ArrayBuffer(24*e.levels.length)),U=(_||p+r.byteLength)+n.byteLength;for(let t=0;t<e.levels.length;t++){let n=e.levels[t];h.push(n.levelData),u.setBigUint64(24*t+0,BigInt(U),!0),u.setBigUint64(24*t+8,BigInt(n.levelData.byteLength),!0),u.setBigUint64(24*t+16,BigInt(n.uncompressedByteLength),!0),U+=n.levelData.byteLength}let d=new ArrayBuffer(68),y=new DataView(d);return y.setUint32(0,e.vkFormat,!0),y.setUint32(4,e.typeSize,!0),y.setUint32(8,e.pixelWidth,!0),y.setUint32(12,e.pixelHeight,!0),y.setUint32(16,e.pixelDepth,!0),y.setUint32(20,e.layerCount,!0),y.setUint32(24,e.faceCount,!0),y.setUint32(28,e.levels.length,!0),y.setUint32(32,e.supercompressionScheme,!0),y.setUint32(36,c,!0),y.setUint32(40,o.byteLength,!0),y.setUint32(44,p,!0),y.setUint32(48,r.byteLength,!0),y.setBigUint64(52,BigInt(n.byteLength>0?_:0),!0),y.setBigUint64(60,BigInt(n.byteLength),!0),new Uint8Array(concat([new Uint8Array(KTX2_ID).buffer,d,u.buffer,o,r,new ArrayBuffer(_>0?_-(p+r.byteLength):0),n,...h]))}var BasisTextureType,SourceType,DefaultOptions={enableDebug:!1,isUASTC:!0,isKTX2File:!0,isInputSRGB:!0,generateMipmap:!0,needSupercompression:!0,isSetKTX2SRGBTransferFunc:!0},canvas=new OffscreenCanvas(128,128),ctx=canvas.getContext("2d",{willReadFrequently:!0}),isInWorker="undefined"==typeof document;function decodeImageData(e){return createImageBitmap(e).then(function(e){return canvas.width=e.width,canvas.height=e.height,ctx.drawImage(e,0,0),ctx.getImageData(0,0,e.width,e.height)})}function encodeToKTX2(e,t){return void 0===t&&(t={}),initBasis().then(function(n){var i=new n.BasisEncoder;return applyInputOptions(t,i),i.setTexType(BasisTextureType.cBASISTexType2D),_instanceof(e,ArrayBuffer)&&(e=new Blob([e])),decodeImageData(e).then(function(e){i.setSliceSourceImage(0,new Uint8Array(e.data),e.width,e.height,SourceType.RAW);var n=new Uint8Array(10485760),s=i.encode(n);if(0===s)throw"encode failed";var r=new Uint8Array(n.buffer,0,s),a=read(n);if(t.kvData){for(var o in t.kvData)a.keyValue[o]=t.kvData[o];r=write(a,{keepWriter:!0})}return r})})}function applyInputOptions(e,t){void 0===e&&(e={}),void 0!==(e=_extends$1({},DefaultOptions,e)).enableDebug&&t.setDebug(e.enableDebug),void 0!==e.isUASTC&&t.setUASTC(e.isUASTC),void 0!==e.isKTX2File&&t.setCreateKTX2File(e.isKTX2File),void 0!==e.isSetKTX2SRGBTransferFunc&&t.setKTX2SRGBTransferFunc(e.isSetKTX2SRGBTransferFunc),void 0!==e.generateMipmap&&t.setMipGen(e.generateMipmap),void 0!==e.isYFlip&&t.setYFlip(e.isYFlip),void 0!==e.qualityLevel&&t.setQualityLevel(e.qualityLevel),void 0!==e.compressionLevel&&t.setCompressionLevel(e.compressionLevel),void 0!==e.needSupercompression&&t.setKTX2UASTCSupercompression(e.needSupercompression),void 0!==e.isNormalMap&&t.setNormalMap(e.isNormalMap)}var promise=null;function initBasis(){return promise||(promise=new Promise(function(e,t){isInWorker?(importScripts("https://mdn.alipayobjects.com/rms/afts/file/A*SrRkQarYYl4AAAAAAAAAAAAAARQnAQ/basis_encoder.js"),fetch("https://mdn.alipayobjects.com/rms/afts/file/A*qFWbTrA0hZYAAAAAAAAAAAAAARQnAQ/basis_encoder.wasm").then(function(e){return e.arrayBuffer()}).then(function(n){BASIS({wasmBinary:n}).then(function(t){t.initializeBasis(),e(t)}).catch(t)}).catch(t)):Promise.all([fetch("https://mdn.alipayobjects.com/rms/afts/file/A*SrRkQarYYl4AAAAAAAAAAAAAARQnAQ/basis_encoder.js").then(function(e){return e.text()}),fetch("https://mdn.alipayobjects.com/rms/afts/file/A*qFWbTrA0hZYAAAAAAAAAAAAAARQnAQ/basis_encoder.wasm").then(function(e){return e.arrayBuffer()})]).then(function(n){var i=n[0],s=n[1],r=document.createElement("script");r.onload=function(){BASIS({wasmBinary:s}).then(function(t){t.initializeBasis(),e(t)}).catch(t)},r.src=URL.createObjectURL(new Blob([i])),r.onerror=t,document.body.appendChild(r)}).catch(t)})),promise}isInWorker&&self.addEventListener("message",function(e){encodeToKTX2(e.data).then(function(e){self.postMessage(e)}).catch(function(e){self.postMessage({error:e})})});export{encodeToKTX2};
